{% extends 'base.html' %}
{% block title %}Мониторинг{% endblock %}
{% block content %}
<h2>Мониторинг ресурсов</h2>
<div class="row">
  <div class="col-md-6 col-lg-4 mb-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">CPU</h5>
        <div class="progress" style="height: 24px;">
          <div id="cpu-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-lg-4 mb-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">RAM</h5>
        <div class="progress" style="height: 24px;">
          <div id="ram-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-lg-4 mb-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Disk</h5>
        <div class="progress" style="height: 24px;">
          <div id="disk-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-lg-4 mb-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Net</h5>
        <div class="progress" style="height: 24px;">
          <div id="net-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0 МБ/c</div>
        </div>
      </div>
    </div>
  </div>
</div>
<h4>Контейнеры</h4>
<div class="mb-3">
  <input type="text" id="containerSearch" class="form-control" placeholder="Поиск по контейнерам...">
</div>
<table class="table table-bordered" id="containers-table">
  <thead>
    <tr><th>Имя</th><th>Образ</th><th>Статус</th></tr>
  </thead>
  <tbody>
    {% for c in containers %}
    <tr><td>{{ c.name }}</td><td>{{ c.image }}</td><td>{{ c.status }}</td></tr>
    {% endfor %}
  </tbody>
</table>
<script>
function formatBytes(bytes) {
  if (bytes === 0 || bytes === undefined) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KiB', 'MiB', 'GiB', 'TiB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
let lastNet = 0;
function updateMonitoring() {
  fetch('/api/monitoring/')
    .then(r => r.json())
    .then(data => {
      // CPU
      let cpu = data.server_stats.cpu;
      let cpuBar = document.getElementById('cpu-bar');
      cpuBar.style.width = cpu + '%';
      cpuBar.setAttribute('aria-valuenow', cpu);
      cpuBar.textContent = cpu + '%';
      cpuBar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
      if (cpu > 90) cpuBar.classList.add('bg-danger');
      else if (cpu > 70) cpuBar.classList.add('bg-warning');
      else cpuBar.classList.add('bg-success');
      // RAM
      let ram = data.server_stats.ram_percent;
      let ramBar = document.getElementById('ram-bar');
      ramBar.style.width = ram + '%';
      ramBar.setAttribute('aria-valuenow', ram);
      ramBar.textContent = ram + '%';
      ramBar.classList.remove('bg-info', 'bg-warning', 'bg-danger');
      if (ram > 90) ramBar.classList.add('bg-danger');
      else if (ram > 70) ramBar.classList.add('bg-warning');
      else ramBar.classList.add('bg-info');
      // Disk
      let disk = data.server_stats.disk_percent;
      let diskBar = document.getElementById('disk-bar');
      diskBar.style.width = disk + '%';
      diskBar.setAttribute('aria-valuenow', disk);
      diskBar.textContent = disk + '%';
      diskBar.classList.remove('bg-warning', 'bg-danger', 'bg-info');
      if (disk > 90) diskBar.classList.add('bg-danger');
      else if (disk > 70) diskBar.classList.add('bg-warning');
      else diskBar.classList.add('bg-info');
      // Net (MB/s)
      let net = data.server_stats.net;
      let netBar = document.getElementById('net-bar');
      let netSpeed = 0;
      if (lastNet > 0) {
        netSpeed = (net - lastNet) / 1024 / 1024 / 3; // MB/s, 3s интервал
      }
      lastNet = net;
      netBar.style.width = Math.min(netSpeed * 10, 100) + '%';
      netBar.setAttribute('aria-valuenow', netSpeed);
      netBar.textContent = netSpeed.toFixed(2) + ' МБ/c';
    });
}
document.addEventListener('DOMContentLoaded', function() {
  updateMonitoring();
  setInterval(updateMonitoring, 3000);
  if (document.getElementById('containerSearch')) {
    document.getElementById('containerSearch').addEventListener('input', function() {
      const val = this.value.toLowerCase();
      document.querySelectorAll('#containers-table tbody tr').forEach(tr => {
        tr.style.display = tr.innerText.toLowerCase().includes(val) ? '' : 'none';
      });
    });
  }
});
</script>
{% endblock %} 